# ImmunoPepper
ImmunoPepper is a software tool for the detection of neoantigens from a splicing graph. It generates the set of all theoretically feasible peptide sequences (or kmers) through
direct translation of all walks along the graph.

The splice graph is generated using the SplAdder pipeline. SplAdder is a software tool for the detection of alternative splicing events
from RNA-Seq data. This splicing graph is generated from one or several alignment files derived from RNA-Seq data in *bam* format,
as well as from a reference annotation file. *Note: The bam file should be accompanied by a bam index file (.bai).*
For more information on how to incorporate this data to generate the input splice graph check out the [build mode of SplAdder](https://spladder.readthedocs.io/en/latest/spladder_modes.html)

This peptide set obtained by using this software tool can be personalized with germline
and somatic variants, and takes all exon-exon junctions present in the splicing graph (even the ones not
part of the reference annotation, but present in the given RNA-Seq sample) into account. The
comprehensive set of peptides can be used subsequently for further downstream analyses, such as
domain annotation or computational immunology.

## Get Started

### Installation

It is recommended to set up a separate virtual or conda environment.
The basic ImmunoPepper package can be installed via `pip`:

```
pip install immunopepper
```

Alternatively, ImmunoPepper can also be installed from source using:
```
pip install -r requirements.txt -r requirements_dev.txt
make install
```

After installation, please consult the help screen for further usage options:
```
immunopepper -h
```
### Prerequisites
ImmunoPepper takes a splicing graph as input. This splicing graph has to be generated using the
SplAdder pipeline. Further information about SplAdder is available on its [GitHub
page](https://github.com/ratschlab/spladder) or the [Online
documentation](https://spladder.readthedocs.io/en/latest/).

## Basic workflow
The software has four basic working modes:

1. [`build`](#mode-build): Core part of ImmunoPepper. Traverses the input splice graph and generates all possible peptides/kmers.
2. [`samplespecif`](#mode-samplespecif): This mode filters from the foreground kmer list the peptides that are also appearing in the background kmer list, and keeps only the novel kmers. It needs to be applied after the build mode.
3. [`cancerspecif`](#mode-cancerspecif): This mode performs a set of filtering steps to remove kmers that are not specific to the different cancer samples. Go to the mode description for more information.
4. [`mhcbind`](#mode-mhcbind): This mode allows the user to perform MHC binding predictions on the kmers generated by Immunopepper. It is a wrapper tool for different MHC binding affinity prediction tools. It currently contains [NetMHC3](http://www.cbs.dtu.dk/services/NetMHC-3.4/), [NetMHC4](http://www.cbs.dtu.dk/services/NetMHC/), [NetMHCpan](http://www.cbs.dtu.dk/services/NetMHCpan/), [NetMHCIIpan](http://www.cbs.dtu.dk/services/NetMHCIIpan/), [NetMHCcons](http://www.cbs.dtu.dk/services/NetMHCcons/ and MHCflurry. #TODO: add link or command for MHCflurry

## Modes

### Mode `build`

The mode `build` is the core part of ImmunoPepper. It traverses the input splice graph and generates all possible peptides/kmers.
Throughout the description of the different parameters we will use two terms worth describing:
- *Background*: This refers to the baseline set of full transcripts found in the organism as described by the annotation file provided under `--ann-path`. In this mode, the complete sequence of exons for each given transcript will be obtained from the annotation file. The regions corresponding to this exons will be taken from the reference genome file provided under `--ref-path`, and they will be translated to create the set of *background* peptides or kmers. In the output, background files are referred to as *annot*. If the user chooses to provide #TODO: add mutation part.
- *Foreground*: It aims at representing the novelty found in the organism. The software focuses on *short-range* novelty, as it only extracts pairs of two exons. In the case where the two exons are not enough to create a kmer of length `--kmer`, the software will use an exon triplet (unless `--disable-concat` is set to True). This mode will extract the exon pairs, or triplets, belonging to each transcript by traversing the splicing graph provided under `--splice-path`. Then, it will extract the sequence corresponding to the exon coordinates from `--ref-path`, and it will be translated to generate *foreground* peptides or kmers. If the user chooses to provide germline variants under `--germline` or somatic mutations under `--somatic`, the nucleotide variations will be applied to the sequence, and they will therefore be reflected in the set of *foreground* peptides and kmers. In the output, foreground files are referred to as *sample*. Moreover, the sample names will contain a prefix indicating the mutation mode that was applied, namely 'ref' (if no mutations were applied), "germline", "somatic" or "somatic_and_germline".
*Note that the current implementation of SplAdder uses the provided annotation as a backbone splice graph and then adds the alternative splicing events found in the RNA-Seq data. Therefore, not all the peptides labeled as foreground will be novel, as some can be obtained from baseline exon pairs/triplets.*

The following parameters are **mandatory**:
- `--output-dir`: absolute path of the output directory. All output files generated by immunopepper will be saved in this directory.
- `--ann-path`: absolute path for the annotation file. Accepted file formats: *.gtf*, *.gff* and *.gff3*. Annotation files can be downloaded from various databases such as [GENCODE](https://www.gencodegenes.org/human/)
- `--splice-path`: absolute path of the input [SplAdder](https://github.com/ratschlab/spladder) splice graph.
- `--ref-path`: absolute path of the reference genome file in FASTA format. Reference Please ensure that the reference genome is compatible with the gene annotation file being used. For example, if the annotation file is based on GRCh38, the reference genome should also be based on GRCh38. You can check [here](https://www.gencodegenes.org/human/releases.html) gencode annotation releases and their corresponding major genome assembly releases. For example, if you decide to use genome assembly version GRCh38.p13, you need to use its compatible annotation file from release 43 in GENCODE.
- `--kmer`: length of the kmers for kmer output.

The following parameters are **optional**:

*Optional submodes* parameters: Commands for conceptual information about the processing.

- `--libsize-extract`: Default = False. Set this parameter to True to generate library sizes and gene quantifications and skip neontigen generation. *Note: If set to True, the program will only output files 3 and 7 of the [output section](#output-files).*
- `--all-read-frames`: Default = False. Set this parameter to True to switch to exhaustive translation and study all possible reading frames instead of just the annotated ones in the annotation file.
- `--count-path`: Default = None. Absolute path for the second output of [SplAdder]((https://github.com/ratschlab/spladder) containing the graph expression quantification. If provided, expression quantification of genes will take place. Format: hdf5.
- `--output-samples`: Default = None. List of sample names to output. *Note: Names should match the file name of the splice graphs. If not provided all samples are processed and program runs faster.*
- `--heter-code`: Default = 0. It specifies the heterozygous allele. Options: 0 or 2. #TODO: provide more info?

*Optional technical* parameters: Commands for optimization of the software.
- `--paralell`: Default = 1. Number of cores to be used.
- `--batch-size`: Default = 1000. Number of genes to be processed in each batch. If bigger batches are selected, the program will be faster, but it will require more memory.
- `--pickle-samples`: Default = []. List of samples to be pickled. Needed if `--use-mut-pickle` is set to True. It will create intermediate files containing mutation information of the selected samples. This command is useful because mutation/variant information needs to be parsed in every run of the software, which is a time-consuming operation. By pickling the mutations, when mutation information is needed, it will be directly loaded from the intermediate pickled files instead than from the original mutation files provided under `--somatic` and `--germline`. This will speed up software re-runs. When dealing with large cohorts, this command is useful to select exactly what files should be pickled. If not provided, all the samples passed in `--mutation-sample` will be pickled. Names should match the sample names of the graph/counts files but an equivalence can be set using `--sample-name-map` from mutation parameters.

*Optional subset* parameters: Commands to select a subset of the genes to be processed.
- `--process-chr`: Default = None. List of chromosomes to be processed. If not provided all chromosomes are processed. The chromosomes names should be provided in the same format as in FASTA and annotation files. For annotations downloaded from GENCODE, this format is **"chrX"**, X being the chromosome number.
- `--complexity-cap`: Default = None. Maximum edge complexity of the graph to be processed. If not provided all graphs are processed.
- `--genes-interest`: Default = None. Genes to be processed. Input is a csv file containing a gencode gene id per line, with no header. The gencode gene id must match the gencode gene ids of the splice graph. Therefore, the format for this argument must match the format of the *gene_id* field of the annotation file used in the build mode of SplAdder and passed under `--ann-path` in immunopepper. If not provided all genes are processed.
- `--start-id`: Default = 0. Id of the first gene in the splice graph to be processed. If not provided all genes are processed.
- `--process-num`: Default = 0. Number of genes to be processed. If provided, the first process-num genes are processed.

*Optional output* parameters: Commands to select output formatting and filtering.
- `--skip-annotation`: Default = False. Set this parameter to True to skip the generation of a background kmer and peptide files.
- `--libsize-path`: #TODO: not used in build mode. Remove?
- `--output-fasta`: Default = False. Set this parameter to True to output the foreground peptides in fasta format. If set to True output number 4 from the [Output files, mode build](#outputs-mode-build) will be generated. If set to False only the kmers will be output.
- `--force-ref-peptides`: Default = False. Set this parameter to True to output mutated peptides even if they are the same as the ones in the reference. The reference in this case are the peptides without any mutations or variants application.
- `--kmer-database`: Default = None. Absolute path of a file containing kmers in one column, without header. If the kmers contained in this database contain the aminoacid isoleucine (I), it will be converted into leucine (L). A file from uniprot or any other standard library can be provided. The kmers provided in this file will not be output if found in the foreground peptides. Please note that is a standard proteome is downloaded from an online resource the proteins should be cut into the kmers length selected under `--kmer`.
- `--gtex-junction-path`: Default = None. Absolute path of whitelist junction path. The junctions of this file will be the only ones output from the tool. Format: hdf5. The hdf5 file should have a key `chrms` indicating the chromosome where the junction is located, a key `pos` containing the starting and ending position of the junction in genomic coordinates, and a key `strand` with information on whether the junction is in the '+' or '-' strand.
- `--disable-concat`: Default = False. Disable the generation of kmers from combinations of more than 2 exons. In this mode, any kmer shorter than `--kmer` will be discarded. By setting this command to False, the generation of kmers from 3 exons is allowed. This might ensure that kmers generated from shorter exons are kept, but one should take into account that kmers translated from 3 exons might have lower confidence. By setting the argument to True the generation of kmers is faster.
- `--disable-process-libsize`: Default = False. Set to True to generate the libsize file (file 7 from the [output section, mode build](#output-mode-build)).

*Optional mutation* parameters: Commands to add somatic and germline mutation information.
- `--mutation-sample`: Default = None. Sample id of the files to which mutations are added. The ids should match the graphs/counts names, but an equivalence can be set with --sample-name-map.
- `--germline`: Default = ''. Absolute path of the germline mutation file. Format: VCF, MAF or h5.
- `--somatic`: Default = ''. Absolute path of the somatic mutation file. Format: VCF, MAF or h5.
- `--sample-name-map`: Default = None. Name mapping to sample names from graphs/counts files. Format: No header. Two columns: *[name of count/graphs file \t name of mutation/pickle file]*. Three columns: *[name of count/graphs file \t name of germline file \t name of somatic file]*. #TODO: add example?
- `--use-mut-pickle`: Default = False. Set to True to save and use pickled mutation dictionary. This command is useful because mutation/variant information needs to be parsed in every run of the software, which is a time-consuming operation. By pickling the mutations, when mutation information is needed, it will be directly loaded from the intermediate pickled files instead than from the original mutation files provided under `--somatic` and `--germline`. This will speed up software re-runs.

#TODO: Keep this but updated with the new parameters? Leave it for a little bit later and test that it runs properly
Example command line (replace `ref` with `germline` to consider mutation information)
```
immunopepper build \
--output-dir tests/test1/current_output_pos \
--ann-path tests/test1/data/test1pos.gtf \
--ref-path tests/test1/data/test1pos.fa \
--splice-path tests/test1/data/posgraph/spladder/genes_graph_conf3.merge_graphs.pickle \
--somatic tests/test1/data/test1pos.maf \
--germline tests/test1/data/test1pos.vcf \
--samples test1pos \
--mutation-mode ref \
--kmer 4 \
--disable-concat \
--count-path  tests/test1/data/posgraph/spladder/genes_graph_conf3.merge_graphs.count.hdf5 \
--gtex-junction-path tests/test1/data/posgraph/spladder/genes_graph_conf3.test1pos.junction.hdf5
```

### Mode `samplespecif`

The following parameters are **mandatory**:

- `--annot-kmer-files`: List of absolute paths to the annotation kmer files. The files should have the name **\[mut_mode\]_annot_peptides.fa** (Files 1 from the [output section](#output-files))
- `--output-dir`: Path to the output directory.
- `--junction-kmer-files`: List of absolute paths to the sample kmer files. The files are the ones inside the folders **\[mut_mode\]_graph_kmer_JuncExpr** (Files 6 from the [output section](#output-files)) #TODO: also SegmExpr?.
- `--bg-file-path`: Absolute path to the intermediate pooled annotation file. This file is the set of unique kmers in `--annot-kmer-files` files. If the file is not provided it will be generated. Format: One column with header 'kmer'.
- `--output-suffix`: Default = 'no-annot'. Suffix to be appended to the filtered `--junction-kmer-files`.

The following parameter is **optional**:

- `--remove-bg`: Default = False. Set to True to remove from `--junction-kmer-files`the kmers in `--bg-file-path`. If set to False, a new column `is_neo_flag` will be added to the `--junction-kmer-files` files. The column will contain False if the kmer is in `--bg-file-path` and True otherwise.

#TODO: Keep this but updated with the new parameters or examples?
Example command line:
```
immunopepper make_bg \
--kmer-files tests/test1/current_output_pos/test1pos/ref_back_kmer.txt tests/test1/current_output_pos/test1pos/ref_back_kmer.txt \
--output-dir tests/test1/current_output_pos/ \
--output-file-path tests/test1/current_output_pos/test1pos/uniq_back_kmer.txt \
--verbose 2
```

### Mode `cancerspecif`

This mode performs different filtering steps to keep only the kmers that are specific to a cancer sample or a cancer cohort. The user can provide different cancer and normal samples to this filtering step.
- *Cancer samples*: These are the files that contain the kmers from the cancer sample. #TODO: check what is exactly the output I take from build mode
- *Normal samples*: These are the files that contain the kmers from the control sample, i.e. the normal tissue. #TODO: check what is exactly the output I take from build mode

**Pipeline for filtering normal samples:**
1. Preprocessing steps: Before the filtering steps, the kmers from the normal samples are preprocessed throughout different steps.
    a. NaNs removal: The entries containing NaNs in the expression matrix are set to zero
    b. Remove the kmers appearing only in the annotation file but not in the samples: The kmers that are present in the annotation file (either `junctionAnnotated` or `ReadFrameAnnotated` are True) but have expression equal to zero across all samples are removed.
    c. Filter for neo-junctions: If the argument `--filterNeojuncCoord` is set to 'A' or 'N', only the kmers belonging to novel junctions are selected. This means that only the kmers with `junctionAnnotated = False` will be selected.
    d. Filter for annotated reading frames: If the argument `--filterAnnotatedRF` is set to 'A' or 'N', only the kmers with a reading frame present in the annotation file are selected. This means that only the kmers with `ReadFrameAnnotated = True` will be selected, discarding the kmers that were obtained by propagating the reading frame along the splice graph.
    e. Filter for whitelist samples: If `--whitelist-normal` is provided, only the selected samples will be retrieved and further studied.
2. Filtering steps: The filtering for normal samples consist on two different criteria. The two criteria below are applied independently, but only the kmers that fulfill both criteria are selected for further study. However, one can decide to apply only one of the two filters or no filter if normal files are not available.
    a. Filter for expression: If any kmer, i.e. at least 1 kmer, has expression above the threshold `--cohort-expr-support-normal`, the kmer is selected. As it has expression higher than the threshold in a normal sample, it cannot be considered as a cancer-specific kmer. Therefore, it is saved as a normal kmer, and it will be removed from the cancer samples.
    b. Filter for number of samples: If a kmer is expressed, i.e. Expression >0, in more than `--n-samples-lim-normal` samples, it is selected. As it is expressed in more than the threshold in a normal sample, it cannot be considered as a cancer-specific kmer. Therefore, it is saved as a normal kmer, and it will be removed from the cancer samples.
3. Combination of the two filtering steps into a single normal database: The kmers that are selected in the two filtering steps are combined into a single database. This database will be used to filter the cancer samples.
4. Filtering with external resources: If `--path-normal-kmer-list` is provided, the kmers in the file will be removed from the normal database. If `--path-normal-kmer-list` is not provided, the normal database will be used as it is.

**Pipeline for filtering cancer samples:**
1. Preprocessing steps: Before the filtering steps, the kmers from the cancer samples are preprocessed throughout different steps.
    a. NaNs removal: The entries containing NaNs in the expression matrix are set to zero
    b. Filter for neo-junctions: If the argument `--filterNeojuncCoord` is set to 'A' or 'C', only the kmers belonging to novel junctions are selected. This means that only the kmers with `junctionAnnotated = False` will be selected.
    c. Filter for annotated reading frames: If the argument `--filterAnnotatedRF` is set to 'A' or 'C', only the kmers with a reading frame present in the annotation file are selected. This means that only the kmers with `ReadFrameAnnotated = True` will be selected, discarding the kmers that were obtained by propagating the reading frame along the splice graph.
    d. Filter for whitelist samples: If `--whitelist-cancer` is provided, only the selected samples will be retrieved and further studied.
2. Filtering steps: The filtering for cancer samples has two different steps. One can request each of the steps independently, and just apply one filtering criteria. If cohort filtering wants to be performed (step b), expression needs to be provided in the form of a matrix.
    a. Sample specific filtering: Following the preprocessing, a sample specific filtering is performed. Each sample is filtered according to an expression threshold set by `--sample-expr-support-cancer`. For each individual sample, only the kmers with an expression level >= `--sample-expr-support-cancer` are selected. If `--sample-expr-support-cancer` is set to 0, only the kmers > `--sample-expr-support-cancer` are selected.
    b. Cohort filtering: After the sample specific filtering, if the cancer files are part of a cohort of patients one can do cross sample filtering. This means that the kmers that are present in more than n samples, n being the value of `--n-samples-lim-cancer`, with an expression higher than `--sample-expr-support-cancer` will be selected. If `--n-samples-lim-cancer` is set to 0, only the kmers with an expression level > `--cohort-expr-support-cancer` will be selected. #TODO: check if it is higher or higher or equal.
3. Combination of the two filtering steps into a single cancer database. Kmers will be selected as cancer specific kmers if they pass both filtering steps, i.e. an intersection of the two filtering steps. By setting `--cancer-support-union`, one can select the kmers that passed either one of them or both of them, i.e. a union of the two filtering steps.
4. Differential filtering: The kmers appearing in the normal database will be removed from the cancerous kmers. This step is performed to remove the kmers that are not specific to the cancer samples.
5. Filtering with external resources: If `--uniprot` is provided, the kmers in the file will be removed from the cancer database. If `--uniprot` is not provided, the cancer database will be used as it is.

The following parameters are **mandatory**:

*Mandatory technical parameters:* Due to the heavy amount of data, this mode uses spark. These are parameters to control spark processing
- `--cores`: Number of cores to use
- `--mem-per-core`: Memory required per core
- `--parallelism`: Parallelism parameter for Spark Java Virtual Machine (JVM). It is the default number of partitions in RDDs returned by certain transformations. Check `--spark.default.parallelism` [here](https://spark.apache.org/docs/latest/configuration.html) for more information.

*Mandatory input helper parameters*: These parameters are used for a better understanding of the input files.
- `--kmer`: Kmer length
- `--ids-cancer-samples`: List of all cancer samples on which to apply filtering. It is a list with the cancer sample id as provided in the expression matrix. #TODO: Is this correct?. If `--paths-cancer-samples` are provided they should be given in the same order.
- `--mut-cancer-samples`: List of mutation modes corresponding to each cancer sample. The list should have the same number of entries as `--ids-cancer-samples`. The possible values are: ['ref', 'somatic','germline', 'somatic_and_germline']. If `--paths-cancer-samples` are provided they should be given in the same order.

*Mandatory general output files*: Parameters for the files that are output by the software regardless of the filtering method.
- `output-dir`: Absolute path to the output directory to save the filtered data.

The following parameters are **optional**:

*Optional technical parameters:* Due to the heavy amount of data, this mode uses spark. These are parameters to control spark processing
- `--out-partitions`: Default = None. This argument is used to select the number of partitions in which the final output file will be saved. If not provided, #TODO: what happens?
- `--scratch-dir`: Default = ''. Os environment variable name containing the cluster scratch directory path. If specified, all the intermediate files will be saved to this directory. If not specified, the intermediate files will be saved to the output directory, specified under `--output-dir`. If the scratch directory is provided, `--interm-dir-norm` and `--interm-dir-cancer` are ignored.
- `--interm-dir-norm`: Default = ''. Custom scratch directory path to save the intermediate files for the normal samples. If not specified, the intermediate files will be saved to the output directory, specified under `--output-dir`.
- `--interm-dir-cancer`: Default = ''. Custom scratch directory path to save the intermediate files for the cancer samples. If not specified, the intermediate files will be saved to the output directory, specified under `--output-dir`.

*Optional input helper parameters*: These parameters are used for a better understanding of the input files.
- `--expression-fields-c`: Default = ['segment_expr', 'junction_expr']. This argument is used to provide the name of the segment and junction expression field in the cancer file. #TODO: check exactly to which files this is looking at.

*Optional general input files parameters*: Parameters for the input files that are used regardless of the filtering method.
- `--whitelist-normal`: Default = None. File containing the whitelist of normal samples. If provided, only the samples in the whitelist will be retrieved and further studied.Format: Tab separated file without a header, with a single column containing sample names.
- `--whitelist-cancer`: Default = None. File containing the whitelist of cancer samples. If provided, only the samples in the whitelist will be retrieved and further studied.Format: Tab separated file without a header, with a single column containing sample names.
- `--path-cancer-libsize`: Default = None. Path for the libsize file of the selected cancer samples. It corresponds with the output 7 of [output, mode build](#output-files)
- `--path-normal-libsize`: Default = None. Path for the libsize of the selected normal samples. It corresponds with the output 7 of [output, mode build](#output-files)
- `--normalizer-cancer-libsize`: Default = median of the libsize. Custom normalization factor for the cancer libsize. Normalization is used to make all the samples comparable and correct for possible biases in data acquisition. #TODO: explain formula?
- `--normalizer-normal-libsize`: Default = median of the libsize. Custom normalization factor for the normal libsize. Normalization is used to make all the samples comparable and correct for possible biases in data acquisition. #TODO: explain formula?

*Optional general output files parameters*: Parameters for the files that are output by the software regardless of the filtering method.
- `--output-count`: Default = ''. Path where the intermediate numbers of kmers remaining after each filtering step will be written. If selected, a file will be written containing the number of kmers present after each filtering step. It might slow down the computations. However, it is useful if there is an interest on intermediate filtering steps. The output can be seen in number ### of output section. #TODO: add number and output link
- `--tag-normals`: Default = ''. Name for the normal cohort used for filtering. Needed when there are various normal cohorts. It will be added to the final output name in order to identify against what normal cohort were the samples filtered.
- `--tag-prefix`: Default = ''. Prefix used for the output files. It is recommended when there are different conditions being studied.

*Optional normal samples statistical filter parameters*: Parameters to fit a negative binomial distribution on normal kmers and use a probabilistic threshold for normal background inclusion.
- `--statistical`: #TODO: not used in the code
- `--expr-high-limit-normal`: #TODO: not used in the code
- `--threshold-noise-normal`: #TODO: not used in the code
- `--tissue-grp-files`: #TODO: not used in the code

*Optional parameters for normal samples filtering*: Parameters to perform the step 2 of the normal filtering pipeline.
- `--path-normal-matrix-segm`: Default = None. Path to the matrix of segment expression of kmers in normal samples. This corresponds to output 5 of [output, mode build](#output-files)
- `--path-normal-matrix-edge`: Default = None. Path to the matrix of junction expression of kmers in normal samples. This corresponds to output 6 of [output, mode build](#output-files)
- `--n-samples-lim-normal`: Default = None. This is the value for threshold b) in step 2 of normal filtering pipeline. This number will set the number of samples in which we need to see any expression of a specific kmer, i.e. expression > 0, to consider it a normal kmer and exclude it as cancer candidate.
- `--cohort-expr-support-normal`: Default = None. This is the value for threshold a) in step 2 of normal filtering pipeline. This number corresponds to the normalized expression we need to see in at least one sample in order to consider a kmer as a normal kmer. If a kmer is found with an expression level higher than this threshold in one or more normal samples it will be considered a normal kmer and excluded as cancer candidate.

*Optional parameters for cancer samples filtering*: Parameters to perform the step 2 of the cancer filtering pipeline.
- `--sample-expr-support-cancer`: #TODO: doesn't have a default. Errors if not provided? This parameter corresponds with the sample specific filtering in the cancer pipeline. The value will correspond to the normalized expression threshold that needs to be reached by each kmer in order to be considered a kmer candidate. Kmers with an expression higher than this threshold in at least one sample will be considered as cancer candidates. #TODO: are samples provided under `--ids_cancer_samples` included in this filtering?
- `--cohort-expr-support-cancer`: Default = None. This parameter corresponds to the expression threshold in cohort specific filtering. It indicates the normalized expression value that needs to be observed in at least `--n-samples-lim-cancer` in order to consider a kmer as a cancer candidate. Kmers with an expression higher than this threshold in at least `--n-samples-lim-cancer` samples will be considered as cancer candidates. The samples provided under `--ids_cancer_samples` will not be included in cohort filtering.
- `--n-samples-lim-cancer`: Default = None. This parameter corresponds to the number of samples threshold in cohort specific filtering. It indicated the minimum number of cancer samples in which one should see an expression higher than `--cohort-expr-support-cancer` in order to consider the kmer as a cancer candidate. Kmers with an expression higher than `--cohort-expr-support-cancer` in at least `--n-samples-lim-cancer` samples will be considered as cancer candidates. The samples provided under `--ids_cancer_samples` will not be included in cohort filtering.
- `--paths-cancer-samples`: Default = ''. #TODO: understand what this is
- `--path-cancer-matrix-segm`: Default = None. Path to the cancer matrix containing segment expression from samples belonging to a cohort. The matrix will have the following dimensions: [kmers * samples]. However, it is more interesting to find novel junction kmers, so a junction expression matrix provided under `--path-cancer-matrix-edge` is the best expression proxy for that kmers. It is advised to provide only `--path-cancer-matrix-edge` and skip the inclusion of this file. This will be the ouput 5 of [output, mode build](#output-files)
- `--path-cancer-matrix-edge`: Default = None. Path to the cancer matrix containing junction expression from samples belonging to a cohort. The matrix will have the following dimensions: [kmers * samples]. This is the best expression proxy for junction kmers. It is advised to provide only this file and skip the inclusion of `--path-cancer-matrix-segm`. This will be the ouput 6 of [output, mode build](#output-files).
- `--cancer-support-union`: Default = False. Parameter to choose how the sample specific filtering and the cohort specific filtering are combined. By default, they are combined by choosing the common kmers to both filtering steps, i.e. performing an intersection. If this parameter is set to True, the union of both filtering steps will be performed, i.e. the kmers that pass either the sample specific filtering or the cohort specific filtering will be kept.

*Optional parameters for the addition of additional backgrounds*: Parameters to add additional backgrounds that will be removed.
- `--path-normal-kmer-list`: Default = None. List of kmers to be added as part of the normal samples. The kmers provided in this list will be included in the normal background, without having to pass any of the filtering steps for the normal data. Format: It can be either a *tsv* or *parquet* file. If *parquet* is the used format, the file should contain kmer in the first column.
- `--uniprot`: Default = None. Path to file containing uniprot kmers. The kmers contained in this databased will be assumed to be not novel peptides, and they will be removed from the cancer filtering output. *Note: It is important to kmerize the peptides downloaded from uniprot database into the length specified in `--kmer`*.

*Optional parameters to add additional filters*: Parameters to add the additional filters shown in step 1 of both pipelines.
- `--filterNeojuncCoord`: Default = ''. Choices = ['C', 'N', 'A']. This argument will filter the neojunctions, and it will retain only the kmers that are generated from neojunctions. These are peptides whose junction coordinates were not part of the annotation files. Selecting this option means that only those kmers with junctionAnnotated = False will be considered for further filtering. This filter is used in the preprocessing (step 1 of cancer and normal pipelines). If 'C' is selected, the filter is only applied to the cancer sample. If 'N' is selected, the filter is only applied to the normal samples. If 'A' is selected, the filter is applied to both cancer and normal samples.
- `--filterAnnotatedRF`: Default = ''. Choices = ['C', 'N', 'A']. This argument will only retrieve kmers that were generated from annotated reading frames and discard those that were obtained by reading frame propagation through the graph. By selecting this option, only kmers generated from reading frames present in the annotation are kept. This means that selecting this option means that only those kmers with ReadFrameAnnotated = True will be selected. This filter is used in the preprocessing (step 1 of cancer and normal pipelines). If 'C' is selected, the filter is only applied to the cancer sample. If 'N' is selected, the filter is only applied to the normal samples. If 'A' is selected, the filter is applied to both cancer and normal samples.

*Optional development parameters*
- `--tot-batches`: Default = None. If selected, the filtering of the background and foreground will be based on hash functions. This parameter will set the total number of batches in which we will divide the foreground and background files to filter, and each of those batches will be assigned a hash value. If `--batch-id` is specified, `--tot-batches` should also be specified.
- `--batch-id`: Default = None. If selected, the filtering of the background and foreground will be based on hash functions. This parameter will set the batch id of the current batch that is being filtered. The batch id should be an integer between 0 and `--tot-batches`. It shows the specific batch that we want to process, out of the `--tot-batches`. If `--batch-id` is specified, `--tot-batches` should also be specified.

### Mode `mhcbind`

The following parameters are *mandatory*:

- `mhc-software-path`: Path for the MHC prediction software. Currently supported: netmhc3, netmhc4, netmhcpan, mhcflurry.
- `--argstring`: Complete command line for the MHC prediction tool passed as a string. One should include here the command that will be directly passed to the selected MHC tool. The two *mandatory* arguments are:
  1.`--mhc-predictor`: This argument will specify the name of the software tool that will be used. The name should be in the format accepted by the library [mhc_tools](https://github.com/openvax/mhctools)
  1. `--output-csv`: This argument will contain the path where the MHC prediction tool will save the results.
  2. `--input-peptides-file`: This argument will have the path to the file containing the set of kmers on which MHC binding affinity prediction will be performed. If `--partitioned-tsv`files are provided, an intermediate file will be created and stored under the path `--input-peptides-file`. This intermediate file will contain the set of all unique kmers present in the partitioned files obtained from `cancerspecif` mode. If one does not want to use the output of `cancerspecif` mode for prediction, the path to the file that will be used for prediction will be directly provided under `--input-peptides-list`.

The following parameters are *optional*:
- `--partitioned-tsv`: Default = None. The input to this command is the path to the folder containing the partitioned tsv files from `cancerspecif` mode (output number #TODO:set number of [output section](#output-files)). If this parameter is set the tool will directly accept the files from cancerspecif mode as input.
- `--bind-score-method`: Default = None. Scoring method to filter the MHC tools predictions. E.g. score, affinity, percentile_rank (only for netmhcpan).
- `--bind-score-threshold`: Default = None. Threshold to filter the MHC tools predictions.All the peptides with a score lower than the threshold will be filtered out and only the ones with a score higher than the threshold will be kept.
- `--less-than`: Default = False. If set to True the `--bind-score-threshold` will be considered as an upper bound instead of a lower bound. This means that peptides with a score higher than this threshold will be filtered out.

## Output files

### Outputs mode `build`
There are 10 files for the `build` mode. `mut_mode` refers to `ref`, `somatic`,  `germline` and `somatic_and_germline`.

1. **\[mut_mode\]_annot_peptides.fa**: FASTA file containing background peptides for each gene transcript. The header shows
the transcript ID and the value is the result peptide. Generated only if `--skip-annotation` is set to False.

```
>ENST00000514520.5
MKLSMKNNIINTQQSFVTMPNVIVPDIEKEIRRMENGACSSFSEDDDSASTSEESENENPHARGSFSYKSLRKGGPSQREQYLPGAIALFNVNNSSNKDQ
```

2. **\[mut_mode\]_annot_kmers**: kmers generated from **\[mut_mode\]_annot_peptides.fa**. There is one column called *kmer* containing each resulting kmer.
Generated only if `--skip-annotation` is set to False.

```
kmer
WLILDYVSD
VIIIHWNAC
TEYPDAKTM
```
3. **gene_expression_detail**: File containing expression for each gene and each sample. Generated only if `--count-path` file is provided.

```
____________________________________________________
| gene                  | sample 1 | ... | sample n |
_____________________________________________________
| ENSMUSG00000025902.13 | 366155   | ... | 0        |
|                       |          |     |          |
| ENSMUSG00000025903.14 | 0        | ... | 0        |
_____________________________________________________
```

4. **\[mut_mode\]_sample_peptides.fa**: FASTA file containing foreground peptides for each gene transcript obtained from traversing splicegraph. The header shows the transcript ID and the value is the result peptide.
Generated only if `--output-fasta` is set to True.

```
>ENST00000513178.1
MKLSMKNNIINTQQSFVTMPNVIVPDIEKEIRRMENGACSSFSEDDDSASTSEESENENPHARGSFSYKSLRKGGPSQREQYLPGAIALFNVNNSSNKD
```
5. **\[mut_mode\]_graph_kmer_SegmExpr**: Folder containing a file with the expression levels of kmers found in one exon. kmers shown in this file are generated from a single exon and are not located in an exon junction. Format: [kmer, coord, isCrossJunction, junctionAnnotated, readFrameAnnotated, sample names (nº columns = nº samples)]
    - *kmer*: str. The kmer sequence
    - *coord*: str. The genomic coordinates of the kmer. Format: start:end:nan:nan:None:None
    - *isCrossJunction*: Boolean. True if the kmer is located in an exon junction. In this case, all the kmers will get False.
    - *junctionAnnotated*: Boolean. True if the junction kmer is appearing in the annotation file provided under `--ann-path`. In this case, all kmers will get False.
    - *readFrameAnnotated*: Boolean. True if the reading frame was appearing in the annotation file provided under `--ann-path`. The flag value will the False if the reading frame was obtained with the immunopepper tool.

```
_________________________________________________________________________________________________________________________________________________________________
kmer       |  coord                                  |  isCrossJunction   |  junctionAnnotated  |    readFrameAnnotated   |   sample 1  |     ...  |   sample n |
_________________________________________________________________________________________________________________________________________________________________
SDFQLIFVF  |    47970995:47971022:nan:nan:None:None  |      False         |        False        |           True          |       0.0   |     ...  |      0.0   |

TLIPEELEP  |    47948807:47948834:nan:nan:None:None  |      False         |        False        |           False         |       0.0   |     ...  |      0.25  |
_________________________________________________________________________________________________________________________________________________________________
```
6. **\[mut_mode\]_graph_kmer_JuncExpr**: Folder containing a file with the expression levels of kmers located across exon junctions. Format: [kmer, coord, isCrossJunction, junctionAnnotated, readFrameAnnotated]
    - *kmer*: str. The kmer sequence
    - *coord*: str. The genomic coordinates of the kmer. Format: start_e1:end_e1:start_e2:end_e2:start_e3:end_e3. If the kmer is only crossing one junction, start_e3 and end_e3 will be `None`.
    - *isCrossJunction*: Boolean. True if the kmer is located in an exon junction. In this case, all the kmers will get True.
    - *junctionAnnotated*: Boolean. True if the junction kmer is appearing in the annotation file provided under `--ann-path`. If this flag is False, it means that it is a novel kmer.
    - *readFrameAnnotated*: Boolean. True if the reading frame was appearing in the annotation file provided under `--ann-path`. The flag value will the False if the reading frame was obtained with the immunopepper tool.

```
___________________________________________________________________________________________________________________________________________________________________________
kmer       |  coord                                            |  isCrossJunction   |  junctionAnnotated  |    readFrameAnnotated   |   sample 1  |     ...  |   sample n |
___________________________________________________________________________________________________________________________________________________________________________
KKEKKSQMI  |    47943370:47943387:47943274:47943284:None:None  |      True          |        False        |           False         |       0.0   |     ...  |      1.0   |

REPEEKKKK  |    47952582:47952584:47943387:47943412:None:None  |      True          |        False        |           True          |       0.0   |     ...  |      0.25  |
_________________________________________________________________________________________________________________________________________________________________
```

7. **expression_counts.libsize.tsv**: File containing 75% of expression and total expression for each sample. Format: sample_id, 75% expression, total expression.
Generated only if `--disable-libsize` is set to False and if `--count-path` file is provided.

```
_______________________________________________________________
sample     |   libsize_75percent    |     libsize_total_count
_______________________________________________________________
sample 1   |       309287.0         |          6256400944.0
sample 2   |       197045.0         |          4167429408.0
_______________________________________________________________
```

8. **Annot_IS_SUCCESS**: Empty file indicating that background generation was successful. Generated only if `--skip-annotation` is set to False.
9. **Output_sample_IS_SUCCESS**: Empty file created if the foreground generation was successful.
10. **\[mut_mode\]_sample_peptides_meta**: File containing details for each peptide generated from an exon pair.

Detail explanation for columns in **\[mut_mode\]_sample_peptides_meta**
- **peptide**: str. The peptide sequence for a specific exon pair of the foreground data.
- **id**: In the format of \[gene_name\]:\[first vertex\]_\[second vertex\]:\[variant_id\]:\[translation_start_position\]:\[kmerType\]. Eg: `ENSG00000198515.13:18_15:0:47952701:2-exons`.
`ENSG00000198515.13` is the gene name, `0_2` means this junction consists of vertex 0 and vertex 2. `0` means there is no
somatic mutation or that it is the first case of all somatic mutation combination cases. `47952701 ` is the translation start position. `2-exons` means that the peptide is made by the combination of 2 exons.
- **readFrame**: int (0,1,2). Reading frame used for translating the peptide.
- **readFrameAnnotated**: True if the reading frame was appearing in the annotation file provided under `--ann-path`. The flag value will the False if the reading frame was obtained with the immunopepper tool.
- **geneName**: str. The name of Gene.
- **geneChr**: str. The Chromosome id where the gene is located.
- **geneStrand**: str ('+', '_'). The strand of gene.
- **mutationMode**: str ('ref', 'somatic', 'germline', 'somatic_and_germline'). Mutation mode
- **hasStopCodon**: int. Indicate if there is stop codon in the junction pair.
- **isJunctionList**: (np.nan, 1, 0). Indicate if the junction pair appear in the given junction whitelist provided under `--gtex-junction-path`.
- **isIsolated**: int. Indicate if the output peptide is actually translated from a single exon instead of two.
- **variantComb**: If mutation files are provided, it shows the somatic mutation combination used in this line of output.
    eg. 5;25 means the somatic mutation of position 5 and 25 take effect in this output. # TODO: include this or just the example down?
- **variantSegExpr**: If mutation file and count file are provided, this field shows the expression of segments where the somatic mutation is in.  If mutation files are not provided the value is set to nan.
    eg. 257.0;123.2 means the segment where the somatic mutation in position 5 is in has counts 257.0 #TODO: include this example?
- **modifiedExonsCoord**: Coordinates for the exons forming the junction. Usually we have 4 number start_v1;stop_v1;start_v2;stop_v2. It is obtained taking into account the CDS reading frame.
- **originalExonsCoord**: Shows the original exon coordinates obtained from splice graph without taking into account the CDS.
- **vertexIdx**: shows the vertex id of the given junction. Eg: 5,6 means this junction pair consists of the fifth and
    sixth vertex.
- **kmerType**: str. Shows whether the peptide was translated from 2 or 3 exons.

```
_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
peptide                                 |  id                                          |    readFrame    |   readFrameAnnotated   |       geneName        |     geneChr   |   geneStrand  |  mutationMode |  hasStopCodon  |  isJunctionList |   isIsolated  |    variantComb |    variantSegExpr     |       modifiedExonsCoord                  |            originalExonsCoord              |     vertexIdx  |  kmerType   |
_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
MKLSMKNNIINTQQSFVTMPNVIVPDIEKEIRRMENGA  | ENSG00000198515.13:18_15:0:47952701:2-exons  |       2         |          True          |   ENSG00000198515.13  |      chr4     |       -       |      ref      |       0        |       nan       |       0       |       nan      |         nan           |   47952582;47952701;47951354;47951469     |     47952582;47952807;47951352;47951469    |        18;15   |   2-exons   |
KSDDKNENKNDPEKKKKKKDKEKKKKEEKSKDKKEEEK  | ENSG00000198515.13:7_4:0:47943287:2-exons    |       2         |          False         |   ENSG00000198515.13  |      chr8     |       +       |      ref      |       0        |       nan       |       0       |       nan      |         nan           |   47943180;47943287;47942042;47942148     |      47943180;47943288;47942040;47942148   |         7;4    |   2-exons   |
_______________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________

```
### Outputs mode `samplespecif`

#TODO: add examples?
The output of this mode is a modified version of the files in **\[mut_mode\]_graph_kmer_JuncExpr** and **\[mut_mode\]_graph_kmer_SegmExpr**. #TODO: check if this last folder too.
If `--remove-bg` is set to False, the files will contain a new column called `is_neo_flag`. This flag will be True if the kmer is unique to the foreground data and False if it is also present in the background data.
If `--remove-bg` is set to True, the mode will return the files without the kmers that are common with the background data.

### Outputs mode `cancer_specific`

### Outputs mode `mhcbind`

#TODO: add examples?
1. **[--input-peptides-file]**: Intermediate file created if `--partitioned-tsv` is provided. It contains the unique set of kmers present in the partitioned tsv files provided, which are the outputs of the cancer specific mode (output number *** #TODO: add number and reference). The file will be stored in the path provided under `--input-peptides-file` in `--argstring`. Format: It will be a csv file, and it will contain a column with the unique kmers, without a header or index.
2. **[--output-csv]**:  Output file generated by the selected MHC tool. Format: csv file, and the exact format will depend on the MHC tool selected. The file will be stored in the path provided under `--output-csv` in `--argstring`.
3. **[--output-csv]_With{`--bind-score-method`}LessLim{`--bind-score-threshold`}.tsv**: File containing the filtered version of **[--output-csv]**. It is generated if filtering options are provided, and `--less-than` is set to True. It will contain kmers that have a score `--bind-score-method` smaller than `--bind-score-threshold`. #TODO: add reference to inner text
4. **[--output-csv]_With{`--bind-score-method`}MoreLim{`--bind-score-threshold`}.tsv**: File containing the filtered version of **[--output-csv]**. It is generated if filtering options are provided, and `--less-than` is set to False. It will contain kmers that have a score `--bind-score-method` bigger than `--bind-score-threshold`. #TODO: add reference to inner text
